{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "C - Hunt Indicators on FortiSIEM",
    "aliasName": null,
    "tag": null,
    "description": "Hunt indicator value on FortiSIEM for the past X Minutes",
    "isActive": true,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [],
    "synchronous": false,
    "lastModifyDate": 1648051474,
    "collection": "\/api\/3\/workflow_collections\/c1ca92eb-8ec4-4dba-9a3d-156bf0a1abc2",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/c1234151-3a97-4688-b1b8-d8817872815e",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Indicator Found",
            "description": null,
            "arguments": {
                "conditions": [
                    {
                        "option": "yes",
                        "step_iri": "\/api\/3\/workflow_steps\/f6fd3068-5a22-426e-b190-ed3e0b6a2f55",
                        "condition": "{{ vars.hunt_results.events|length > 0 }}",
                        "step_name": "Update Indicator"
                    },
                    {
                        "option": "no",
                        "default": true,
                        "step_iri": "\/api\/3\/workflow_steps\/470ae745-1b3a-4562-bc8f-c399204834eb",
                        "step_name": "Exit"
                    }
                ]
            },
            "status": null,
            "top": "435",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/12254cf5-5db7-4b1a-8cb1-3af081924b28",
            "uuid": "0e67658a-7bf2-4bdd-aea5-18e01f221b32",
            "id": 15575
        },
        {
            "@type": "WorkflowStep",
            "name": "Add Eradication Guiding Comment",
            "description": null,
            "arguments": {
                "resource": {
                    "type": {
                        "id": 248,
                        "@id": "\/api\/3\/picklists\/ff599189-3eeb-4c86-acb0-a7915e85ac3b",
                        "icon": null,
                        "uuid": "ff599189-3eeb-4c86-acb0-a7915e85ac3b",
                        "@type": "Picklist",
                        "color": null,
                        "display": "Comment",
                        "@context": "\/api\/3\/contexts\/Picklist",
                        "listName": "\/api\/3\/picklist_names\/0841c1eb-a0a3-4abd-b29c-9f68e4d9b14f",
                        "itemValue": "Comment",
                        "orderIndex": 1
                    },
                    "people": [],
                    "content": "<div>\n<div>{{globalVars.Action_Icon}} Indicator <span style=\"color: #fbeeb8;\">{{vars.input.records[0].value}}<\/span> has been found on Assets: <span style=\"color: #fbeeb8;\">{{vars.infected_assets|join(' ')}}<\/span>.<\/div>\n<ul>\n<li>Set the incident Phase to: <span style=\"font-size: 12pt;\"><strong>&lt;&lt; Recovery &gt;&gt;<\/strong><\/span><\/li>\n<li>Browse to <span style=\"font-size: 12pt;\"><strong>Correlations &gt; Assets<\/strong><\/span>, select all infected Assets and run the playbook: <span style=\"font-size: 12pt;\"><strong>Quarantine Infected Assets<\/strong><\/span><\/li>\n<\/ul>\n<\/div>",
                    "__replace": "",
                    "incidents": "{{vars.linked_incidents_iris}}",
                    "isImportant": false,
                    "peopleUpdated": false
                },
                "_showJson": false,
                "operation": "Overwrite",
                "collection": "\/api\/3\/comments",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Overwrite"
                },
                "step_variables": []
            },
            "status": null,
            "top": "1246",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "uuid": "3943bc3d-e3c6-46ab-8ffc-88d10c83dcfc",
            "id": 15586
        },
        {
            "@type": "WorkflowStep",
            "name": "Compute Infected Assets",
            "description": null,
            "arguments": {
                "__append_infected_assets": "{%if vars.hunt_artifacts.IP | length > 0%}\n{%for entry in vars.hunt_artifacts.IP%}\n{%set tmp_entry=entry|ipv4(\"10.0.0.0\/8\") or entry|ipv4(\"172.16.0.0\/12\") or entry|ipv4(\"192.168.0.0\/16\")%}\n{%if tmp_entry%}{{vars.infected_assets.append(entry)}}{%endif%}\n{%endfor%}\n{%endif%}"
            },
            "status": null,
            "top": "975",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "uuid": "401b01ef-8607-4b5f-ac1b-45667af84004",
            "id": 15578
        },
        {
            "@type": "WorkflowStep",
            "name": "Exit",
            "description": null,
            "arguments": {
                "params": [],
                "version": "3.2.0",
                "connector": "cyops_utilities",
                "operation": "no_op",
                "operationTitle": "Utils: No Operation",
                "step_variables": []
            },
            "status": null,
            "top": "570",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "uuid": "470ae745-1b3a-4562-bc8f-c399204834eb",
            "id": 15576
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Assets",
            "description": null,
            "arguments": {
                "when": "{{vars.infected_assets|length > 0}}",
                "for_each": {
                    "item": "{{vars.infected_assets}}",
                    "__bulk": true,
                    "parallel": false,
                    "condition": "",
                    "batch_size": 100
                },
                "resource": {
                    "ip": "{{vars.item}}",
                    "name": "{{vars.item}}",
                    "tenant": "\/api\/3\/tenants\/b3a700f7-00be-4ef9-90c6-3c8fe6e1be63",
                    "hostname": "{{vars.item}}",
                    "__replace": "true",
                    "incidents": "{{vars.linked_incidents_iris}}",
                    "indicators": "{{vars.input.records[0]['@id']}}"
                },
                "_showJson": false,
                "operation": "Overwrite",
                "collection": "\/api\/3\/upsert\/assets",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Overwrite"
                },
                "step_variables": []
            },
            "status": null,
            "top": "1111",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "uuid": "7a1206ce-1362-4e30-98d0-b092d6314949",
            "id": 15579
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Hunt Record",
            "description": null,
            "arguments": {
                "resource": {
                    "name": "{{vars.input.records[0].value}}",
                    "huntEnd": "{{globalVars.Current_Date}}",
                    "__replace": "true",
                    "huntStart": "{{globalVars.Current_Date}}",
                    "incidents": "{{vars.linked_incidents_iris}}",
                    "indicators": "{{vars.input.records[0]['@id']}}",
                    "sourceData": "{{vars.hunt_results}}",
                    "timeCreated": "{{globalVars.Current_Date}}"
                },
                "_showJson": false,
                "operation": "Overwrite",
                "collection": "\/api\/3\/upsert\/hunt",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Overwrite"
                },
                "step_variables": []
            },
            "status": null,
            "top": "705",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "uuid": "8455ee15-6583-444b-83bf-10dcab06ecc1",
            "id": 15574
        },
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "infected_assets": "[]",
                "linked_incidents": "{{(vars.input.records[0]['@id']+\"\/incidents\")|fromIRI}}",
                "mock_hunt_result": "{\n    \"data\": {\n      \"@start\": \"0\",\n      \"events\": [\n        {\n          \"id\": \"5071756875901541967\",\n          \"nid\": \"5071756875901541967\",\n          \"index\": \"0\",\n          \"custId\": \"1\",\n          \"dataStr\": null,\n          \"eventType\": \"FortiClient-traffic-userbrowsed\",\n          \"attributes\": {\n            \"user\": \"dricardo\",\n            \"eventName\": \"FortiClient user web browsing activity\",\n            \"eventType\": \"FortiClient-traffic-userbrowsed\",\n            \"phRecvTime\": \"{{arrow.utcnow().shift(minutes=-(range(10,15)|random))}}\",\n            \"rawEventMsg\": \"<190>Mar 23 07:00:07 time=17:12:21 date=2022-03-22 time=17:12:21 logver=2 type='traffic' level='info' sessionid=112238820 hostname='DESKTOP-MTLI2U1' pcdomain= uid='4BEEAC757E204AA1AD168D10132A45C4' devname='FCTEMS0366038394' devid='FCT8002987898160' fgtserial='N\/A' emsserial='FCTEMS0366038394' regip=N\/A srcname='chrome.exe' srcproduct='Google Chrome' srcip=N\/A srcport=N\/A direction='outbound' dstip=N\/A remotename='{{vars.input.records[0].value}}' dstport=443 user='dricardo' proto=6 rcvdbyte=N\/A sentbyte=N\/A utmaction='userbrowsed' utmevent='webfilter' threat='N\/A' vd='root' fctver='6.8.6.1167' os='Microsoft Windows 10 Professional Edition, 64-bit (build 16299)' usingpolicy='FCT_Logging' service='https' url='\/~sgtatham\/putty\/latest.html' userinitiated=1 browsetime=18\",\n            \"reptDevIpAddr\": \"10.200.3.23\"\n          },\n          \"receiveTime\": \"{{arrow.utcnow().shift(minutes=-(range(10,15)|random))}}\"\n        },\n        {\n          \"id\": \"5071756875901491799\",\n          \"nid\": \"5071756875901491799\",\n          \"index\": \"1\",\n          \"custId\": \"1\",\n          \"dataStr\": null,\n          \"eventType\": \"FortiClient-traffic-userbrowsed\",\n          \"attributes\": {\n            \"user\": \"dricardo\",\n            \"eventName\": \"FortiClient user web browsing activity\",\n            \"eventType\": \"FortiClient-traffic-userbrowsed\",\n            \"phRecvTime\": \"{{arrow.utcnow().shift(minutes=-(range(10,15)|random))}}\",\n            \"rawEventMsg\": \"<190>Mar 23 07:00:07 time=17:12:21 date=2022-03-22 time=17:12:21 logver=2 type='traffic' level='info' sessionid=112238820 hostname='DESKTOP-MTLI2U1' pcdomain= uid='4BEEAC757E204AA1AD168D10132A45C4' devname='FCTEMS0366038394' devid='FCT8002987898160' fgtserial='N\/A' emsserial='FCTEMS0366038394' regip=N\/A srcname='chrome.exe' srcproduct='Google Chrome' srcip=N\/A srcport=N\/A direction='outbound' dstip=N\/A remotename='{{vars.input.records[0].value}}' dstport=443 user='dricardo' proto=6 rcvdbyte=N\/A sentbyte=N\/A utmaction='userbrowsed' utmevent='webfilter' threat='N\/A' vd='root' fctver='6.8.6.1167' os='Microsoft Windows 10 Professional Edition, 64-bit (build 16299)' usingpolicy='FCT_Logging' service='https' url='\/~sgtatham\/putty\/latest.html' userinitiated=1 browsetime=18\",\n            \"reptDevIpAddr\": \"10.200.3.23\"\n          },\n          \"receiveTime\": \"{{arrow.utcnow().shift(minutes=-(range(10,15)|random))}}\"\n        },\n        {\n          \"id\": \"5071756875900869445\",\n          \"nid\": \"5071756875900869445\",\n          \"index\": \"2\",\n          \"custId\": \"1\",\n          \"dataStr\": null,\n          \"eventType\": \"FortiClient-traffic-userbrowsed\",\n          \"attributes\": {\n            \"user\": \"dricardo\",\n            \"eventName\": \"FortiClient user web browsing activity\",\n            \"eventType\": \"FortiClient-traffic-userbrowsed\",\n            \"phRecvTime\": \"{{arrow.utcnow().shift(minutes=-(range(10,15)|random))}}\",\n            \"rawEventMsg\": \"<190>Mar 23 07:00:07 time=17:12:21 date=2022-03-22 time=17:12:21 logver=2 type='traffic' level='info' sessionid=112238820 hostname='DESKTOP-MTLI2U1' pcdomain= uid='4BEEAC757E204AA1AD168D10132A45C4' devname='FCTEMS0366038394' devid='FCT8002987898160' fgtserial='N\/A' emsserial='FCTEMS0366038394' regip=N\/A srcname='chrome.exe' srcproduct='Google Chrome' srcip=N\/A srcport=N\/A direction='outbound' dstip=N\/A remotename='{{vars.input.records[0].value}}' dstport=443 user='dricardo' proto=6 rcvdbyte=N\/A sentbyte=N\/A utmaction='userbrowsed' utmevent='webfilter' threat='N\/A' vd='root' fctver='6.8.6.1167' os='Microsoft Windows 10 Professional Edition, 64-bit (build 16299)' usingpolicy='FCT_Logging' service='https' url='\/~sgtatham\/putty\/latest.html' userinitiated=1 browsetime=18\",\n            \"reptDevIpAddr\": \"10.200.3.23\"\n          },\n          \"receiveTime\": \"{{arrow.utcnow().shift(minutes=-(range(10,15)|random))}}\"\n        }\n      ],\n      \"@queryId\": \"75802,1648040008493\",\n      \"@errorCode\": \"0\",\n      \"@totalCount\": \"3\"\n    },\n    \"status\": \"Success\",\n    \"message\": \"\",\n    \"operation\": null\n  }",
                "hunt_for_past_x_minutes": "5"
            },
            "status": null,
            "top": "165",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "uuid": "a75ea7da-c964-4ad3-bd22-4b57f821d078",
            "id": 15572
        },
        {
            "@type": "WorkflowStep",
            "name": "Compute Hunt Indficators",
            "description": null,
            "arguments": {
                "hunt_artifacts": "{{vars.hunt_results|extract_artifacts}}"
            },
            "status": null,
            "top": "840",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "uuid": "b3d97c24-86b3-4746-9c20-b60c4633b0e9",
            "id": 15577
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "route": "8ec5b671-343a-4435-ae9a-2b13c83de8c2",
                "resources": [
                    "indicators"
                ],
                "inputVariables": [],
                "step_variables": {
                    "input": {
                        "params": [],
                        "records": "{{vars.input.records}}"
                    },
                    "useMockOutput": "{{globalVars.Demo_mode}}"
                },
                "displayConditions": {
                    "indicators": {
                        "sort": [],
                        "limit": 30,
                        "logic": "AND",
                        "filters": [
                            {
                                "type": "primitive",
                                "field": "value",
                                "value": "false",
                                "operator": "isnull",
                                "_operator": "isnull"
                            }
                        ]
                    }
                },
                "executeButtonText": "Execute",
                "noRecordExecution": false,
                "singleRecordExecution": true
            },
            "status": null,
            "top": "30",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/f414d039-bb0d-4e59-9c39-a8f1e880b18a",
            "uuid": "c1234151-3a97-4688-b1b8-d8817872815e",
            "id": 15570
        },
        {
            "@type": "WorkflowStep",
            "name": "Hunt indicator",
            "description": null,
            "arguments": {
                "name": "Fortinet FortiSIEM",
                "config": "06b6f056-184f-4b10-9573-6f8d1c83c013",
                "params": {
                    "start": 0,
                    "value": "{{vars.hunt_for_past_x_minutes}}",
                    "perPage": 50,
                    "rel_time": "Minutes",
                    "attribute": [
                        "Raw Event Log"
                    ],
                    "select_clause": "phRecvTime,reptDevIpAddr,eventType,eventName,srcIpAddr,destIpAddr,user,rawEventMsg",
                    "time_selection": "Relative Time",
                    "raw_event_log_value": "{{vars.input.records[0].value}}"
                },
                "version": "4.3.1",
                "connector": "fortinet-fortisiem",
                "operation": "search_events",
                "mock_result": "{%if vars.input.records[0].typeofindicator.itemValue in [\"IP Address\",\"URL\"]%}{{vars.mock_hunt_result}}{%endif%}",
                "operationTitle": "Search Events",
                "pickFromTenant": false,
                "step_variables": {
                    "hunt_results": "{{vars.result.data}}",
                    "linked_incidents_iris": "{%if vars.linked_incidents[\"hydra:member\"]|length > 0%}{{vars.linked_incidents[\"hydra:member\"]|json_query(\"[][\\\"@id\\\"][]\")}}{%endif%}"
                }
            },
            "status": null,
            "top": "300",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/0bfed618-0316-11e7-93ae-92361f002671",
            "uuid": "ebb37b28-97cb-40c8-bfe5-f83fafcac3af",
            "id": 15571
        },
        {
            "@type": "WorkflowStep",
            "name": "Update Indicator",
            "description": null,
            "arguments": {
                "resource": {
                    "tlp": {
                        "id": 312,
                        "@id": "\/api\/3\/picklists\/0472d368-bd15-4f52-a119-d403470cbe43",
                        "icon": null,
                        "uuid": "0472d368-bd15-4f52-a119-d403470cbe43",
                        "@type": "Picklist",
                        "color": "#FF0000",
                        "display": "Red",
                        "listName": "\/api\/3\/picklist_names\/40f1345f-f679-43c0-9237-5b06edd8385f",
                        "itemValue": "Red",
                        "orderIndex": 0
                    }
                },
                "_showJson": false,
                "operation": "Append",
                "collection": "{{vars.input.records[0]['@id']}}",
                "__recommend": [],
                "collectionType": "\/api\/3\/indicators",
                "fieldOperation": {
                    "recordTags": "Append"
                },
                "step_variables": []
            },
            "status": null,
            "top": "570",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928722",
            "uuid": "f6fd3068-5a22-426e-b190-ed3e0b6a2f55",
            "id": 15573
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Compute Infected Assets -> Create Assets",
            "targetStep": "\/api\/3\/workflow_steps\/7a1206ce-1362-4e30-98d0-b092d6314949",
            "sourceStep": "\/api\/3\/workflow_steps\/401b01ef-8607-4b5f-ac1b-45667af84004",
            "label": null,
            "isExecuted": false,
            "uuid": "c75ca0cb-a3f9-430f-bec1-9c4690569fd6"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Create Assets -> Add Attachment Guiding Comment",
            "targetStep": "\/api\/3\/workflow_steps\/3943bc3d-e3c6-46ab-8ffc-88d10c83dcfc",
            "sourceStep": "\/api\/3\/workflow_steps\/7a1206ce-1362-4e30-98d0-b092d6314949",
            "label": null,
            "isExecuted": false,
            "uuid": "6fb8aaf9-32e8-4621-9650-61934112d893"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Configuration",
            "targetStep": "\/api\/3\/workflow_steps\/a75ea7da-c964-4ad3-bd22-4b57f821d078",
            "sourceStep": "\/api\/3\/workflow_steps\/c1234151-3a97-4688-b1b8-d8817872815e",
            "label": null,
            "isExecuted": false,
            "uuid": "1aa9b59c-8134-4c4b-85ec-e8d5da2a94f3"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Hunt indicator",
            "targetStep": "\/api\/3\/workflow_steps\/ebb37b28-97cb-40c8-bfe5-f83fafcac3af",
            "sourceStep": "\/api\/3\/workflow_steps\/a75ea7da-c964-4ad3-bd22-4b57f821d078",
            "label": null,
            "isExecuted": false,
            "uuid": "3054d0a6-e199-4142-92f1-d86d1d54e621"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Update Indicator -> Create Hunt Record",
            "targetStep": "\/api\/3\/workflow_steps\/8455ee15-6583-444b-83bf-10dcab06ecc1",
            "sourceStep": "\/api\/3\/workflow_steps\/f6fd3068-5a22-426e-b190-ed3e0b6a2f55",
            "label": null,
            "isExecuted": false,
            "uuid": "033d5e28-8e09-4f9e-b736-7a8dd32ffcf9"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Hunt indicator -> Indicator Found",
            "targetStep": "\/api\/3\/workflow_steps\/0e67658a-7bf2-4bdd-aea5-18e01f221b32",
            "sourceStep": "\/api\/3\/workflow_steps\/ebb37b28-97cb-40c8-bfe5-f83fafcac3af",
            "label": null,
            "isExecuted": false,
            "uuid": "afdc6fae-c3c0-4401-987e-b9c3a0ee6292"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Indicator Found -> Update Indicator",
            "targetStep": "\/api\/3\/workflow_steps\/f6fd3068-5a22-426e-b190-ed3e0b6a2f55",
            "sourceStep": "\/api\/3\/workflow_steps\/0e67658a-7bf2-4bdd-aea5-18e01f221b32",
            "label": "yes",
            "isExecuted": false,
            "uuid": "d5570aa4-b546-4292-bcbd-03e8d3894f90"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Indicator Found -> Exit",
            "targetStep": "\/api\/3\/workflow_steps\/470ae745-1b3a-4562-bc8f-c399204834eb",
            "sourceStep": "\/api\/3\/workflow_steps\/0e67658a-7bf2-4bdd-aea5-18e01f221b32",
            "label": "no",
            "isExecuted": false,
            "uuid": "0f504836-a8c5-4a1d-bce2-da75415544c9"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Create Hunt Record -> Compute Infected Assets",
            "targetStep": "\/api\/3\/workflow_steps\/b3d97c24-86b3-4746-9c20-b60c4633b0e9",
            "sourceStep": "\/api\/3\/workflow_steps\/8455ee15-6583-444b-83bf-10dcab06ecc1",
            "label": null,
            "isExecuted": false,
            "uuid": "e356f58e-974f-46ca-aa0b-f5f1b7935ee7"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Compute Hunt Indficators -> Copy  of Compute Hunt Indficators",
            "targetStep": "\/api\/3\/workflow_steps\/401b01ef-8607-4b5f-ac1b-45667af84004",
            "sourceStep": "\/api\/3\/workflow_steps\/b3d97c24-86b3-4746-9c20-b60c4633b0e9",
            "label": null,
            "isExecuted": false,
            "uuid": "48f7d141-ccb6-4f1d-9b3c-5b72b06d43b7"
        }
    ],
    "priority": "\/api\/3\/picklists\/2b563c61-ae2c-41c0-a85a-c9709585e3f2",
    "uuid": "34991a82-7944-46fc-b3a5-afd16f58dc0c",
    "recordTags": [
        "Threat_Hunting"
    ],
    "id": 2931,
    "createUser": "\/api\/3\/people\/3451141c-bac6-467c-8d72-85e0fab569ce",
    "createDate": 1647970563,
    "modifyUser": "\/api\/3\/people\/3451141c-bac6-467c-8d72-85e0fab569ce",
    "modifyDate": 1648051474,
    "owners": [],
    "isPrivate": false
}