{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "> Extract Phishing Indicators",
    "aliasName": null,
    "tag": "#PostCreate #system",
    "description": "Create Indicator for specified fields in alert",
    "isActive": true,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "alertMetaData"
    ],
    "synchronous": false,
    "lastModifyDate": 1647947519,
    "collection": "\/api\/3\/workflow_collections\/c1ca92eb-8ec4-4dba-9a3d-156bf0a1abc2",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/2b8b24bf-b533-4ad1-b922-4a8a1256d5c4",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": "You can customize extraction by modifying indicator map in configuration step",
            "arguments": {
                "ips": "{{globalVars.Excludelist_IPs.split(',')}}",
                "urls": "{{globalVars.Excludelist_URLs.split(',')}}",
                "hosts": "{{globalVars.Excludelist_Hosts.split(',')}}",
                "domains": "{{globalVars.Excludelist_Domains.split(',')}}",
                "alert_iri": "{{vars.input.params.alertMetaData['@id'] | ternary(vars.input.params.alertMetaData['@id'],vars.input.records[0]['@id'])}}",
                "unified_iocs": "[]",
                "alert_metadata": "{{vars.input.params.alertMetaData | ternary(vars.input.params.alertMetaData,vars.input.records[0])}}",
                "alert_field_iocs": "[]",
                "indicator_type_map": "{{globalVars.Indicator_type_map}}",
                "excluded_indicators": "[]"
            },
            "status": null,
            "top": "165",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "uuid": "27dd0bf6-1be8-4897-8ed3-afef13e1572b",
            "id": 15405
        },
        {
            "@type": "WorkflowStep",
            "name": "Wait for Indicators",
            "description": null,
            "arguments": {
                "delay": {
                    "days": 0,
                    "hours": 0,
                    "weeks": 0,
                    "minutes": 0,
                    "seconds": 10
                }
            },
            "status": null,
            "top": "1243",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/6832e556-b9c7-497a-babe-feda3bd27dbf",
            "uuid": "28edca40-6c06-4f6e-9bbf-098202209ec9",
            "id": 15400
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "resource": "alerts",
                "resources": [
                    "alerts"
                ],
                "step_variables": {
                    "input": {
                        "params": {
                            "alertMetaData": "{{ vars.alertMetaData }}"
                        },
                        "records": [
                            "{{vars.input.records[0]}}"
                        ]
                    }
                },
                "fieldbasedtrigger": {
                    "sort": [],
                    "limit": 30,
                    "logic": "AND",
                    "filters": [
                        {
                            "type": "object",
                            "field": "state",
                            "value": "\/api\/3\/picklists\/501d0562-89a0-4079-9a9e-cdde7d34e3ed",
                            "_value": {
                                "@id": "\/api\/3\/picklists\/501d0562-89a0-4079-9a9e-cdde7d34e3ed",
                                "display": "Indicator Extracted",
                                "itemValue": "Indicator Extracted"
                            },
                            "operator": "neq"
                        }
                    ]
                }
            },
            "status": null,
            "top": "30",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/ea155646-3821-4542-9702-b246da430a8d",
            "uuid": "2b8b24bf-b533-4ad1-b922-4a8a1256d5c4",
            "id": 15404
        },
        {
            "@type": "WorkflowStep",
            "name": "Update Alert State",
            "description": null,
            "arguments": {
                "resource": {
                    "state": {
                        "id": 71,
                        "@id": "\/api\/3\/picklists\/501d0562-89a0-4079-9a9e-cdde7d34e3ed",
                        "icon": null,
                        "@type": "Picklist",
                        "color": null,
                        "display": "Indicator Extracted",
                        "listName": "\/api\/3\/picklist_names\/2f9ed741-25fe-475a-9f12-64336288eebf",
                        "itemValue": "Indicator Extracted",
                        "orderIndex": 2
                    }
                },
                "_showJson": false,
                "operation": "Overwrite",
                "collection": "{{vars.input.records[0]['@id']}}",
                "collectionType": "\/api\/3\/alerts",
                "fieldOperation": {
                    "recordTags": "Overwrite"
                },
                "step_variables": []
            },
            "status": null,
            "top": "1512",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928722",
            "uuid": "3f8e0d01-ce59-4c63-849d-dacd8a6148d4",
            "id": 15406
        },
        {
            "@type": "WorkflowStep",
            "name": "Unified Email IOCs",
            "description": null,
            "arguments": {
                "_dummy": "{%if vars.email_body_iocs %} \n{%for item in vars.email_body_iocs%}\n{{vars.unified_iocs.append(item)}}\n{%endfor%}\n{%endif%}\n\n{%if vars.header_iocs%}\n{%for item in vars.header_iocs%}\n{{vars.unified_iocs.append(item)}}\n{%endfor%}\n{%endif%}\n\n{%if vars.file_hash_iocs %}\n{%for item in vars.file_hash_iocs%}\n{{vars.unified_iocs.append(item)}}\n{%endfor%}\n{%endif%}\n\n{%for item in vars.alert_field_iocs%}\n{{vars.unified_iocs.append(item)}}\n{%endfor%}"
            },
            "status": null,
            "top": "974",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "uuid": "49a61af0-2761-4779-99c4-989db35fb279",
            "id": 15398
        },
        {
            "@type": "WorkflowStep",
            "name": "Wait for Enrichment",
            "description": null,
            "arguments": {
                "query": {
                    "sort": [],
                    "limit": 30,
                    "logic": "AND",
                    "filters": [
                        {
                            "type": "primitive",
                            "field": "alerts.id",
                            "value": "{{vars.input.records[0].id}}",
                            "operator": "eq",
                            "_operator": "eq"
                        },
                        {
                            "type": "object",
                            "field": "reputation",
                            "value": "\/api\/3\/picklists\/ae98ebc6-beef-4882-9980-1d88fc6d87cd",
                            "_value": {
                                "@id": "\/api\/3\/picklists\/ae98ebc6-beef-4882-9980-1d88fc6d87cd",
                                "itemValue": "TBD"
                            },
                            "operator": "neq"
                        }
                    ]
                },
                "module": "indicators?$limit=30",
                "do_until": {
                    "delay": "65",
                    "retries": "2",
                    "condition": "{{vars.result | length == 0}}"
                },
                "checkboxFields": false,
                "step_variables": []
            },
            "status": null,
            "top": "1377",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928770",
            "uuid": "4f9044a9-aa23-4c73-9152-0486cf0264c2",
            "id": 15401
        },
        {
            "@type": "WorkflowStep",
            "name": "Extract Indicators from body",
            "description": "This is step is specifically designed for 'Suspicious Email' Alert",
            "arguments": {
                "name": "CyOps Utilities",
                "when": "{{vars.input.records[0].emailBody or vars.input.params.alertMetaData.emailBody}}",
                "params": {
                    "data": "{{vars.input.params.alertMetaData.emailBody | ternary(vars.input.params.alertMetaData.emailBody,vars.input.records[0].emailBody)}}",
                    "whitelist": "{{vars.excluded_indicators}}",
                    "case_sensitive": "",
                    "override_regex": "",
                    "private_whitelist": ""
                },
                "version": "3.0.3",
                "connector": "cyops_utilities",
                "operation": "extract_artifacts",
                "operationTitle": "CyOPs: Extract Artifacts from string",
                "step_variables": {
                    "email_body_iocs": "{{vars.result.data.results}}"
                },
                "operationOutput": []
            },
            "status": null,
            "top": "839",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/0bfed618-0316-11e7-93ae-92361f002671",
            "uuid": "6ebf9bf1-8e2f-4a87-8df5-5e33537fbfaa",
            "id": 15397
        },
        {
            "@type": "WorkflowStep",
            "name": "Extract Indicators from header",
            "description": "This is step is specifically designed for 'Suspicious Email' Alert",
            "arguments": {
                "name": "CyOps Utilities",
                "when": "{{vars.input.records[0].returnPath or vars.input.params.alertMetaData.returnPath}}",
                "params": {
                    "data": "{{vars.input.params.alertMetaData.returnPath| ternary(vars.input.params.alertMetaData.returnPath,vars.input.records[0].returnPath)}}",
                    "whitelist": "{{vars.excluded_indicators}}",
                    "case_sensitive": "",
                    "override_regex": "",
                    "private_whitelist": ""
                },
                "version": "3.0.3",
                "connector": "cyops_utilities",
                "operation": "extract_artifacts",
                "operationTitle": "CyOPs: Extract Artifacts from string",
                "step_variables": {
                    "header_iocs": "{{vars.result.data.results}}"
                },
                "operationOutput": []
            },
            "status": null,
            "top": "705",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/0bfed618-0316-11e7-93ae-92361f002671",
            "uuid": "82660dc7-bf9d-4495-ac56-42154e0f2eb2",
            "id": 15402
        },
        {
            "@type": "WorkflowStep",
            "name": "Get Indicators",
            "description": null,
            "arguments": {
                "alert_field_iocs": "{{ vars.alert_field_iocs | json_query('[?value != null]') }}"
            },
            "status": null,
            "top": "570",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "uuid": "981fabc0-4d86-4299-aab1-85af350b2d42",
            "id": 15403
        },
        {
            "@type": "WorkflowStep",
            "name": "Update Indicator List",
            "description": null,
            "arguments": {
                "temp": "{% for  key,value in vars.indicator_type_map.items() %}\n{%if vars.alert_metadata.get(key) and vars.alert_metadata.get(key) not in vars.excluded_indicators %}\n{{vars.alert_field_iocs.append({\"type\": value, \"value\":vars.alert_metadata.get(key)})}}\n{%endif%}\n{%endfor%}"
            },
            "status": null,
            "top": "435",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "uuid": "b3555c97-0639-4962-b724-c3ccb5ccccc6",
            "id": 15399
        },
        {
            "@type": "WorkflowStep",
            "name": "Compute Excluded Indicators",
            "description": null,
            "arguments": {
                "excluded_indicators": "{{vars.ips | union(vars.hosts)| union(vars.domains) | union(vars.urls)}}"
            },
            "status": null,
            "top": "300",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "uuid": "e64cab7e-1892-41bb-a8c1-264b61e2e48f",
            "id": 15407
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Indicators",
            "description": null,
            "arguments": {
                "for_each": {
                    "item": "{{vars.unified_iocs | batch(200) | list}}",
                    "parallel": false,
                    "condition": ""
                },
                "arguments": {
                    "alert_iri": "{{vars.alert_iri}}",
                    "indicator_list": "{{ vars.item }}"
                },
                "apply_async": false,
                "step_variables": [],
                "workflowReference": "\/api\/3\/workflows\/490983c9-df55-4484-b8c9-9cd176f0056e"
            },
            "status": null,
            "top": "1109",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/74932bdc-b8b6-4d24-88c4-1a4dfbc524f3",
            "uuid": "fab3869f-56e1-4175-a833-ba1584d9ccc5",
            "id": 15396
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Extract Indicators from body -> Unified Email IOCs",
            "targetStep": "\/api\/3\/workflow_steps\/49a61af0-2761-4779-99c4-989db35fb279",
            "sourceStep": "\/api\/3\/workflow_steps\/6ebf9bf1-8e2f-4a87-8df5-5e33537fbfaa",
            "label": null,
            "isExecuted": false,
            "uuid": "2612e74b-0bb2-40b6-99ec-eecd0d12dbb4"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Create Indicators -> Wait for Indicators",
            "targetStep": "\/api\/3\/workflow_steps\/28edca40-6c06-4f6e-9bbf-098202209ec9",
            "sourceStep": "\/api\/3\/workflow_steps\/fab3869f-56e1-4175-a833-ba1584d9ccc5",
            "label": null,
            "isExecuted": false,
            "uuid": "d08e1ef1-4483-4508-9e9c-df74cade6eff"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Get Indicators -> Extract Indicators from header",
            "targetStep": "\/api\/3\/workflow_steps\/82660dc7-bf9d-4495-ac56-42154e0f2eb2",
            "sourceStep": "\/api\/3\/workflow_steps\/981fabc0-4d86-4299-aab1-85af350b2d42",
            "label": null,
            "isExecuted": false,
            "uuid": "d81e24d8-653c-4348-9a95-38e22a25350d"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Copy  of Update Indicator List -> Update Indicator List",
            "targetStep": "\/api\/3\/workflow_steps\/b3555c97-0639-4962-b724-c3ccb5ccccc6",
            "sourceStep": "\/api\/3\/workflow_steps\/e64cab7e-1892-41bb-a8c1-264b61e2e48f",
            "label": null,
            "isExecuted": false,
            "uuid": "3d288416-8aae-4e9c-ace5-fe1c6bdb3110"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Configuration",
            "targetStep": "\/api\/3\/workflow_steps\/27dd0bf6-1be8-4897-8ed3-afef13e1572b",
            "sourceStep": "\/api\/3\/workflow_steps\/2b8b24bf-b533-4ad1-b922-4a8a1256d5c4",
            "label": null,
            "isExecuted": false,
            "uuid": "f6133b46-eced-4b72-8492-4a8164be63c5"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Unified Email IOCs -> Create Indicators batch wise",
            "targetStep": "\/api\/3\/workflow_steps\/fab3869f-56e1-4175-a833-ba1584d9ccc5",
            "sourceStep": "\/api\/3\/workflow_steps\/49a61af0-2761-4779-99c4-989db35fb279",
            "label": null,
            "isExecuted": false,
            "uuid": "a8c2262e-fc3d-4c33-8d1c-6472dce0f686"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Wait for Indicators -> Wait for Enrichment",
            "targetStep": "\/api\/3\/workflow_steps\/4f9044a9-aa23-4c73-9152-0486cf0264c2",
            "sourceStep": "\/api\/3\/workflow_steps\/28edca40-6c06-4f6e-9bbf-098202209ec9",
            "label": null,
            "isExecuted": false,
            "uuid": "4b7a7eff-b013-46d9-a221-7d7ddbd4ccbd"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Copy  of Update Indicator List",
            "targetStep": "\/api\/3\/workflow_steps\/e64cab7e-1892-41bb-a8c1-264b61e2e48f",
            "sourceStep": "\/api\/3\/workflow_steps\/27dd0bf6-1be8-4897-8ed3-afef13e1572b",
            "label": null,
            "isExecuted": false,
            "uuid": "bee601bc-1b06-418d-8020-1e4801ecd54c"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Extract Indicators from header -> Extract Indicators from body",
            "targetStep": "\/api\/3\/workflow_steps\/6ebf9bf1-8e2f-4a87-8df5-5e33537fbfaa",
            "sourceStep": "\/api\/3\/workflow_steps\/82660dc7-bf9d-4495-ac56-42154e0f2eb2",
            "label": null,
            "isExecuted": false,
            "uuid": "ab062d41-ab5d-4080-b0d5-ad439fe9bab0"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Check Reputation Status -> Update Alert State",
            "targetStep": "\/api\/3\/workflow_steps\/3f8e0d01-ce59-4c63-849d-dacd8a6148d4",
            "sourceStep": "\/api\/3\/workflow_steps\/4f9044a9-aa23-4c73-9152-0486cf0264c2",
            "label": null,
            "isExecuted": false,
            "uuid": "ad7ca8f7-36d4-4529-abbb-43453b4829f1"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Update Indicator List -> Get Indicators",
            "targetStep": "\/api\/3\/workflow_steps\/981fabc0-4d86-4299-aab1-85af350b2d42",
            "sourceStep": "\/api\/3\/workflow_steps\/b3555c97-0639-4962-b724-c3ccb5ccccc6",
            "label": null,
            "isExecuted": false,
            "uuid": "70adb9c9-ca4f-45b4-9d92-9cc99e7adf01"
        }
    ],
    "priority": null,
    "uuid": "004ed824-0d7c-422a-a465-75dc6fed5e4e",
    "recordTags": [
        "PostCreate"
    ],
    "id": 2912,
    "createUser": "\/api\/3\/people\/3451141c-bac6-467c-8d72-85e0fab569ce",
    "createDate": 1647947520,
    "modifyUser": "\/api\/3\/people\/3451141c-bac6-467c-8d72-85e0fab569ce",
    "modifyDate": 1647947520,
    "owners": [],
    "isPrivate": false
}